<script>
  var map = L.map('map').setView([-0.13, 117.48], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  var poiLayer;
  var poiData;

  fetch('sbsk_foto5.geojson')
    .then(response => response.json())
    .then(data => {
      poiData = data;
      poiLayer = L.layerGroup().addTo(map);
      updateMap();
    });

  function updateMap() {

    if (!poiLayer || !poiData) return;

    poiLayer.clearLayers();

    var nama_satker = document.getElementById("nama_satker").value;
    var jarakcbd_km = document.getElementById("jarakcbd_km").value;

    var geojsonLayer = L.geoJSON(poiData, {
      filter: function (feature) {

        if (nama_satker !== "all" &&
            feature.properties.nama_satker !== nama_satker)
          return false;

        if (jarakcbd_km !== "all" &&
            feature.properties.jarakcbd_km > Number(jarakcbd_km))
          return false;

        return true;
      },

      onEachFeature: function (feature, layer) {

        var p = feature.properties;

        var popupContent =
          "<b>" + p.nama_satker + "</b><br>" +
          "Kode Barang: " + p.kode_barang + "<br>" +
          "NUP: " + p.nup + "<br>" +
          "Jenis Barang: " + p.jenis_barang + "<br>" +
          "Luas: " + p.luas_m2 + " m²<br>" +
          "Jarak ke CBD: <b>" + p.jarakcbd_km + " km</b><br>" +
          "<img src='" + p.foto + "' width='250'>";

        layer.bindPopup(popupContent);
      }
    });

    geojsonLayer.addTo(poiLayer);

    if (poiLayer.getLayers().length > 0) {
      map.fitBounds(poiLayer.getBounds());
    }
  }
</script>
